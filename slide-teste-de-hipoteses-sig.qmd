---
title: "Desvendando o valor-p: uma abordagem intuitiva"
format: 
  revealjs:
      logo: img/brasao1_horizontal_cor_300dpi.png
      theme: simple
      css: logo.css
progress: true
slide-number: true
editor: visual
editor_options: 
  chunk_output_type: console
---

```{r}
#| include: false
source("./_common.R")
```

```{r}
library(conflicted)
library(tidyverse)
library(janitor)
library(dslabs)
library(gt)
library(rstatix)
library(scales)
conflicts_prefer(dplyr::filter())
conflicts_prefer(dplyr::lag)
```

```{r}
mice_weights <- mice_weights |> 
  as_tibble()
```

```{r}
set.seed(123)

mice_exp <- mice_weights |> 
  slice_sample(n = 10, by = diet) |> 
  mutate(
    diet = fct_relevel(diet,"hf", "chow")
  )
```

## Voc√™ tem uma ideia brilhante! ‚ú®

-   Pode ser um novo tratamento, um m√©todo de ensino inovador, uma nova estrat√©gia de marketing...
-   Voc√™ acredita que sua ideia vai causar uma **mudan√ßa**, um **efeito** positivo!

## A "Voz da Desconfian√ßa": Hip√≥tese Nula ($H_0$) {.smaller}

-   Antes de comemorar, surge uma d√∫vida:
    -   *"E se sua ideia n√£o fizer diferen√ßa nenhuma?"*
    -   *"E se qualquer resultado for apenas obra do **acaso** ou varia√ß√µes normais?"*
-   Essa "voz" √© a **Hip√≥tese Nula (**$H_0$):
    -   Afirma que **N√ÉO H√Å EFEITO** ou diferen√ßa real
    -   Sua ideia n√£o muda nada em rela√ß√£o ao status quo ou a um grupo controle

## O experimento e seus resultados üìä

-   Voc√™ realiza um estudo para testar sua ideia:
    -   Compara um grupo que recebe sua interven√ß√£o com um grupo controle
    -   Coleta dados (ex: notas de alunos, melhora de pacientes, vendas)
-   Voc√™ observa alguma diferen√ßa nos resultados entre os grupos
    -   Ex: Seu grupo experimental teve um desempenho 10% melhor

## A grande pergunta do valor-p ü§î

-   Voc√™ observa uma diferen√ßa. Mas...
-   **SE** a sua ideia n√£o tivesse NENHUM efeito real (ou seja, se a Hip√≥tese Nula $H_0$ fosse verdadeira)...
-   ... Qual seria a **CHANCE** de voc√™ observar uma diferen√ßa t√£o grande quanto a que voc√™ viu (ou at√© maior), s√≥ por puro **ACASO**?

## Valor-p: a defini√ß√£o üí°

-   **O Valor-p √â ESSA CHANCE!**
-   √â uma probabilidade (um n√∫mero entre 0 e 1, ou 0% e 100%)
-   Ele quantifica o qu√£o "surpreendente" ou "raro" seria o seu resultado se a Hip√≥tese Nula ($H_0$) fosse verdadeira (ou seja, se n√£o houvesse efeito real)

## Interpretando o valor-p (Parte 1)

-   Valor-p PEQUENO (ex: 0.01 ou 1%)
    -   **Significado:** "Nossa! Se minha ideia n√£o tivesse efeito, a chance de ver um resultado t√£o bom (ou melhor) s√≥ por sorte seria de apenas 1%. Isso √© bem raro!"
-   **Pensamento:** Como √© t√£o improv√°vel obter esse resultado por acaso (se $H_0$ fosse verdadeira), talvez a $H_0$ esteja errada
-   **Implica√ß√£o:** Os dados parecem "estranhos" para um mundo onde nada acontece. Talvez sua ideia **realmente tenha um efeito**

## Interpretando o Valor-p (Parte 2)

-   Valor-p GRANDE (ex: 0.40 ou 40%)
    -   **Significado:** "Hmm... Se minha ideia n√£o tivesse efeito, a chance de ver um resultado como este (ou mais extremo) s√≥ por sorte seria de 40%. Isso n√£o √© t√£o raro"
-   **Pensamento:** meus resultados poderiam facilmente ter acontecido por acaso, mesmo que minha ideia n√£o fizesse diferen√ßa
-   **Implica√ß√£o:** os dados **N√ÉO** parecem "estranhos" para um mundo onde nada acontece. N√£o tenho evid√™ncias fortes para duvidar da $H_0$

## Analogia: o "medidor de estranheza" üëΩ

-   Pense no valor-p como um "Medidor de Estranheza" dos seus dados, sempre sob a **suposi√ß√£o de que a** $H_0$ (nenhum efeito) √© verdadeira
-   **Valor-p pequeno:** Seus dados s√£o "MUITO ESTRANHOS" para um mundo sem efeito. Talvez algo especial *esteja* acontecendo!
-   **Valor-p grande:** Seus dados "N√ÉO S√ÉO NADA ESTRANHOS" para um mundo sem efeito. Encaixam-se na varia√ß√£o normal do acaso

## O limiar decisivo: n√≠vel de signific√¢ncia ($\alpha$) {.smaller}

-   Frequentemente, comparamos o valor-p a um **n√≠vel de signific√¢ncia (**$\alpha$) pr√©-definido
    -   Comumente, $\alpha = 0.05$ (ou 5%).
-   **Regra geral:**
    -   Se **valor-p \<** $\alpha$: Resultado "estatisticamente significativo". Rejeitamos $H_0$. H√° evid√™ncia de um efeito
    -   Se **valor-p** $\ge \alpha$: Resultado "n√£o estatisticamente significativo". N√£o rejeitamos $H_0$. N√£o h√° evid√™ncia suficiente de um efeito

## O que o valor-p N√ÉO √©! üö´ (Muito Importante)

-   **N√ÉO √©** a probabilidade da Hip√≥tese Nula ($H_0$) ser verdadeira
-   **N√ÉO √©** a probabilidade da sua ideia (Hip√≥tese Alternativa) ser verdadeira
-   Um valor-p pequeno (significante) **N√ÉO indica** o qu√£o *grande* ou *importante* √© o efeito. Apenas sugere que o efeito provavelmente n√£o √© zero

## Em resumo: o papel do valor-p üéØ

-   O valor-p ajuda a decidir se os resultados do seu estudo s√£o fortes o suficiente para **questionar a ideia de que "nada aconteceu"** (a Hip√≥tese Nula $H_0$)
-   Ele quantifica a probabilidade dos seus dados (ou dados mais extremos) ocorrerem **SE** sua interven√ß√£o n√£o tivesse efeito real e tudo fosse obra do acaso
-   √â uma ferramenta para auxiliar na tomada de decis√µes baseadas em evid√™ncias

## Lembre-se! üß†

-   O valor-p √© uma pe√ßa do quebra-cabe√ßa, n√£o a imagem inteira.
-   Considere sempre:
    -   O tamanho do efeito
    -   O desenho do estudo
    -   O contexto da sua pesquisa
-   Use o valor-p com sabedoria!

# Um exemplo: ratos, dietas e ganho de peso

##  {background-image="img/bioterio.png" background-size="contain"}

## O cen√°rio do estudo

-   Temos um biot√©rio com 780 ratos (nossa popula√ß√£o)
-   Queremos responder a seguinte pergunta:
    -   Uma dieta rica em gordura realmente leva a um maior ganho de peso?
-   Para isso vamos formular a seguinte hip√≥tese:
    -   Ratos submetidos a uma dieta rica em gordura (hf) ter√£o, em m√©dia, maior peso quando comparados com aqueles submetidos √† dieta controle (chow)

## O experimento

-   Passo 1: Selecionamos aleatoriamente 20 ratos do nosso biot√©rio (dos 780)
-   Passo 2: Distribu√≠mos aleatoriamente estes 20 ratos em dois grupos:
    -   Grupo Experimental (GE): 10 ratos recebem a dieta rica em gordura ("hf")
    -   Grupo Controle (GC): 10 ratos recebem a dieta regular ("chow")

## O que encontramos na amostra?

```{r}
#| out-width: 70%
mice_exp |> 
  ggplot(
    aes(x = diet, y = body_weight, color = diet)
    ) + 
  geom_boxplot(
    show.legend = F
    ) + 
  labs(
    x = "Dieta",
    y = "Peso corporal",
    title = "Distribui√ß√£o do peso corporal nos grupos amostrais"
  )
```

## O que encontramos na amostra?

```{r}
mice_exp |> 
  summarise(
    M√©dia = mean(body_weight),
    .by = diet
  ) |> 
  mutate(
    Diferen√ßa = M√©dia - lag(M√©dia)
  ) |> 
  rename(
    "Dieta" = diet
  ) |> 
  gt() |> 
  sub_missing(
    missing_text = "-"
  ) |> 
  fmt_number(
    decimals = 2.23
    ) |> 
  cols_align(
    align = "center"  
  ) |> 
  tab_options(
    table.width = pct(100),
    table.font.size = "26px"
  ) |> 
  opt_stylize(
    style = 1, color = "gray"
    )
```

```{r}
valor_observado <- mice_exp |> 
  summarise(
    m = mean(body_weight), 
    .by = diet
  ) |> 
  mutate(
    valor_observado = m - lag(m)
  ) |> 
  select(valor_observado) |> 
  slice(2)
```

## O que encontramos na amostra?

```{r}
#| eval: false
levene_test(mice_exp, body_weight ~ diet)

mice_exp |> 
  group_by(diet) |> 
  shapiro_test(body_weight)
```

```{r}
mice_exp |> 
  t_test(body_weight ~ diet,var.equal = T) |> 
  
  select(-starts_with("n"), 
         -starts_with("group")) |> 
  add_column(valor_observado, .after = 1) |> 
  rename(
    VD = .y.,
    "Diferen√ßa observada" = valor_observado,
    t = statistic,
    gl = df
  ) |> 
  gt() |> 
  fmt_number() |> 
  cols_align(
    align = "center"  
  ) |> 
  tab_options(
    table.width = pct(100),
    table.font.size = "26px"
  ) |> 
  opt_stylize(
    style = 1, color = "gray"
    )
```

## A pergunta fundamental: e se a dieta n√£o tivesse efeito?

-   Vamos supor, por um momento, que a dieta N√ÉO TEM NENHUM EFEITO sobre o peso dos ratos
    -   Esta √© a nossa Hip√≥tese Nula ($H_0$)
-   Se $H_0$ √© verdadeira, qualquer diferen√ßa de peso que observamos entre dois grupos aleat√≥rios seria puramente devido ao ACASO da sele√ß√£o e atribui√ß√£o dos ratos
-   Pergunta-chave: "Qu√£o prov√°vel √© obter uma diferen√ßa de 9.10 (ou maior) apenas por acaso, se a dieta n√£o faz diferen√ßa?"

## Simulando o "acaso": a ideia da distribui√ß√£o nula {.smaller}

Construindo um mundo onde a $H_0$ √© verdadeira

-   Para responder √† pergunta anterior, vamos simular muitos "experimentos" onde sabemos que a dieta n√£o tem efeito
-   Usaremos os 780 ratos do biot√©rio como nossa "popula√ß√£o de refer√™ncia" para essas simula√ß√µes
-   Se repetidamente pegarmos amostras aleat√≥rias de ratos desta "popula√ß√£o" e os dividirmos em dois grupos aleatoriamente (sem aplicar dietas diferentes de fato), qual seria a distribui√ß√£o das diferen√ßas de m√©dias de peso?

## A simula√ß√£o da distribui√ß√£o nula {.smaller}

::: {style="font-size: 18pt"}
Passo a passo da simula√ß√£o:

-   Loop (repetir 5000 vezes):
    -   Amostragem: pegue aleatoriamente 20 ratos da "popula√ß√£o" de 780
    -   Atribui√ß√£o aleat√≥ria: divida esses 20 ratos aleatoriamente em dois novos grupos:
        -   "Grupo Simulado A" (10 ratos)
        -   "Grupo Simulado B" (10 ratos)[^1]
    -   C√°lculo: calcule a diferen√ßa entre o peso m√©dio do "Grupo Simulado A" e do "Grupo Simulado B"
    -   Registro: guarde essa diferen√ßa
-   Resultado: teremos 5000 diferen√ßas de m√©dias, cada uma gerada sob a suposi√ß√£o de que n√£o h√° efeito real da "dieta" (pois os grupos foram formados ao acaso)
:::

[^1]: Importante: nesta etapa, os r√≥tulos "hf" ou "chow" originais s√£o ignorados; a atribui√ß√£o √© totalmente aleat√≥ria, simulando a aus√™ncia de efeito da dieta

## Como seria o conjunto de dados?

```{r}
set.seed(456)

distri_nula <- map(
  1:5000, \(x)
  
  mice_weights |> 
    select(body_weight) |> 
    slice_sample(n = 20, replace = T) |> 
    mutate(
      group = sample(rep(c("a", "b"), each = 10))
    )
  )
```

```{r}
distri_nula[c(1, 2, 3)] |> 
  list_cbind() |> 
  slice(1:10) |> 
  gt() |> 
  cols_align(
    align = "center"
    ) |> 
  cols_label(
    body_weight...1 = "Peso corporal",
    body_weight...3 = "Peso corporal",
    body_weight...5 = "Peso corporal",
    group...2 = "Grupo",
    group...4 = "Grupo",
    group...6 = "Grupo"
  ) |> 
  tab_spanner(
    label = "Amostra 1", columns = c(1,2)
  ) |> 
  tab_spanner(
    label = "Amostra 2", columns = c(3,4)
  ) |> 
  tab_spanner(
    label = "Amostra 3", columns = c(5,6)
  ) |> 
  tab_header(
    title = "Exemplo de 3 amostras das 5000 simula√ß√µes geradas"
  ) |> 
  tab_footnote(
    footnote = "Cada amostra tem 20 casos. Somente 10 casos s√£o apresentados para a tabela caber no slide."
      ) |> 
  tab_options(
    table.width = pct(100),
    table.font.size = "22px"
  ) |> 
  opt_stylize(
    style = 1, color = "gray"
    )
```

```{r}
distri_nula_df <- distri_nula %>%
  map(
    \(x) x |> 
      summarise(m = mean(body_weight), .by = group) |> 
      mutate(dif = m - lag(m)) |> 
      filter(!is.na(dif)) |> 
      select(dif)
  ) |> 
  list_rbind() |> 
  as_tibble()
```

```{r}
valor_observado <- valor_observado |> 
  pull()
```

## As diferen√ßas geradas pelo puro acaso {.smaller}

Esta distribui√ß√£o √© chamada de Distribui√ß√£o Nula. Ela representa como as diferen√ßas de m√©dias se comportariam se a dieta n√£o tivesse efeito:

```{r}
#| out-width: 70%
#| fig-align: center
distri_nula_df |> 
  ggplot(
    aes(dif)
    ) + 
  geom_histogram(
    fill = "#569BBD",
    color = "#FFFFFF"
  ) +
  labs(
    title = "Histograma das 5000 diferen√ßas de m√©dias simuladas",
    subtitle = "Varia√ß√£o esperada apenas por acaso se a H0 for verdadeira"
  )
```

## Onde se encaixa nosso resultado real: comparando o observado com o simulado {.smaller}

-   A pergunta agora √©: o qu√£o "extremo" ou "incomum" √© a diferen√ßa entre as m√©dias observadas no experimento em rela√ß√£o a esta distribui√ß√£o de diferen√ßas geradas por acaso?
-   Lembre-se que a hip√≥tese pressup√µe um resultado espec√≠fico: ratos com dieta rica em gordura ter√£o, em m√©dia, maior peso. Nesse sentido √© uma hip√≥tese unilateral
    -   No gr√°fico a seguir, portanto, vamos nos preocupar somente com os casos que est√£o acima do valor observado no experimento real

## Onde se encaixa nosso resultado real: visualizando o valor observado na distribui√ß√£o nula

```{r}
#| fig-align: center
valor_observado_txt <- str_c("Valor observado = ", valor_observado)

distri_nula_df |> 
  mutate(
    p_valor = case_when(dif > valor_observado ~ "ressaltar",
                        .default = "n_ressaltar")
  ) |> 
  ggplot(
    aes(dif, fill = p_valor,
        color = p_valor)
    ) + 
  geom_histogram(
    show.legend = F
    ) + 
  annotate(
    "text", label = valor_observado_txt, 
    x = 6, y = 510, size = 4, color = "red"
    ) +
  geom_vline(
    xintercept = valor_observado,
    color = "red",linetype = 2
  ) + 
  labs(
    y = "Frequ√™ncia nas Simula√ß√µes",
    x = "Diferen√ßa entre as m√©dias"
    ) + 
  scale_fill_manual(
    values = c(ressaltar = "#EF7259", n_ressaltar = "white")
  ) +
  scale_color_manual(
    values = c(ressaltar = "gray", n_ressaltar = "gray")
  )
```

## Calculando o valor-p (unilateral): quantificando o "qu√£o extremo?" {.smaller .scrollable}

Passo 1: olhando para a Distribui√ß√£o Nula, contamos quantas das 5000 diferen√ßas simuladas foram maiores ou iguais a nossa difern√ßa observada (`r valor_observado`).

```{r}
casos_p_uni <- distri_nula_df |> 
  filter(dif > valor_observado) |> 
  nrow()

distri_nula_df |> 
  filter(dif > valor_observado) |> 
  arrange(desc(dif)) |> 
  mutate(
    Quantidade = 1:n(),
    .before = 1
  ) |> 
  gt() |> 
  cols_align(
    align = "center"  
  ) |> 
  tab_options(
    table.width = pct(25),
    table.font.size = "26px"
  ) |> 
  opt_stylize(
    style = 1, color = "gray"
    )
  
```

## Calculando o valor-p (unilateral): quantificando o "qu√£o extremo?" {.smaller}

-   Passo 2: esse total de m√©dias (`r casos_p_uni`) equivale a qual percentual dentre as `r nrow(distri_nula_df)`?

    -   `r casos_p_uni`/`r nrow(distri_nula_df)` = `r casos_p_uni/nrow(distri_nula_df)`

    -   `r casos_p_uni/nrow(distri_nula_df)` = `r label_percent(accuracy = 0.01)(casos_p_uni/nrow(distri_nula_df))`

    -   Este percentual (ou propor√ß√£o) √© o valor-p (unilateral).

-   Defini√ß√£o: "O valor-p √© a probabilidade de observar uma diferen√ßa de m√©dias t√£o grande quanto (ou maior que) a que encontramos no nosso experimento, SE a hip√≥tese nula (de que n√£o h√° efeito da dieta) fosse verdadeira"

-   No exemplo: h√° uma chance de \~`r label_percent(accuracy = 0.01)(casos_p_uni/nrow(distri_nula_df))` de obter uma diferen√ßa de peso de `r valor_observado` ou mais, apenas por acaso, se a dieta n√£o tivesse efeito

-   Em um universo onde sabemos que essa diferen√ßa n√£o existe, com uma chance t√£o pequena de encontrar a diferen√ßa de m√©dias observado no experimento, o que √© poss√≠vel concluir sobre as hip√≥teses?

## O que o valor-p nos diz? {.smaller}

-   Usamos um limiar (n√≠vel de signific√¢ncia, Œ±), geralmente Œ± = 0.05 (ou 5%)
-   Se o valor-p \< Œ± (ex: `r casos_p_uni/nrow(distri_nula_df)` \< 0.05)
    -   O resultado observado no nosso experimento √© incomum ou "surpreendente" se a hip√≥tese nula fosse verdadeira.
    -   Isso nos d√° evid√™ncias para rejeitar a Hip√≥tese Nula ($H_0$)
    -   Conclu√≠mos que provavelmente existe um efeito real da dieta
-   Se o valor-p ‚â• Œ± (ex: 0.0696 \> 0.05)
    -   O resultado observado n√£o √© t√£o incomum sob a hip√≥tese nula. Ele poderia facilmente ter acontecido por acaso.
    -   N√£o temos evid√™ncias suficientes para rejeitar a Hip√≥tese Nula ($H_0$)
    -   Importante: Isso n√£o significa que $H_0$ √© verdadeira, apenas que n√£o conseguimos provar o contr√°rio com esta amostra

# Voltando aos ratos e as dietas

##  {background-image="img/experimento-computador.png" background-size="contain"}

## Conclus√£o para o exemplo

-   O valor observado foi de `r valor_observado`
-   O valor-p unilateral simulado foi de `r casos_p_uni/nrow(distri_nula_df)`
-   Como `r casos_p_uni/nrow(distri_nula_df)` \< 0.05 (nosso Œ±), rejeitamos a $H_0$
-   H√° evid√™ncias estat√≠sticas (baseadas na nossa simula√ß√£o e amostra) que sugerem que a dieta rica em gordura ("hf") de fato leva a um peso corporal maior em compara√ß√£o com a dieta comum ("chow")

## Hip√≥tese bilateral: considerando extremos em ambas as dire√ß√µes {.smaller}

::: {style="font-size: 18pt"}
-   √Äs vezes, queremos saber a probabilidade de uma diferen√ßa t√£o extrema quanto a observada, em qualquer dire√ß√£o (positiva ou negativa)
    -   No experimento, por exemplo, poder√≠amos ter a seguinte hip√≥tese: haver√°, em m√©dia, diren√ßas no peso entre os ratos submetidos a dietas distintas (regular - chow - e rica em gordura - hf)
    -   Note que n√£o estipulamos qual dos grupos ter√° maior m√©dia peso. Nesse sentido, podemos ter os seguintes cen√°rios:
        -   Ratos com dieta rica em gordura mais pesados e ratos com dieta regular mais leves:
            -   hf - chow = valor positivo
        -   Ratos com dieta rica em gordura mais leves e ratos com dieta regular mais pesados:
            -   hf - chow = valor negativo
-   Numa situa√ß√£o como essa, temos que considerar as duas extremidades da distribui√ß√£o para levarmos em conta os valores positivos e negativos
:::

## Visualizando o valor observado na distribui√ß√£o nula: hip√≥tese bilateral

```{r}
#| out-width: "70%"
distri_nula_df |> 
  mutate(
    p_valor = case_when(dif > valor_observado ~ "ressaltar",
                        dif < -valor_observado ~ "ressaltar",
                        .default = "n_ressaltar")
  ) |> 
  ggplot(
    aes(dif, fill = p_valor,
        color = p_valor)
    ) + 
  geom_histogram(
    show.legend = F
    ) + 
  geom_vline(
    xintercept = valor_observado,
    color = "red",linetype = 2
  ) +
  geom_vline(
    xintercept = -valor_observado,
    color = "red",linetype = 2
  ) + 
  labs(
    y = "Frequ√™ncia nas Simula√ß√µes",
    x = "Diferen√ßa entre as m√©dias"
    ) + 
  scale_fill_manual(
    values = c(ressaltar = "#EF7259", n_ressaltar = "white")
  ) +
  scale_color_manual(
    values = c(ressaltar = "gray", n_ressaltar = "gray")
  )
```

## O valor-p na hip√≥tese bilateral

```{r}
p_bilateral <- mean(abs(distri_nula_df$dif) > abs(valor_observado))
p_bilateral_percent <- label_percent(accuracy = 0.01)(p_bilateral)

```

-   Na hip√≥tese bilateral, consideramos as diferen√ßas simuladas que s√£o mais extremas que o valor observado, em ambas as dire√ß√µes. Ou seja, contamos quantas diferen√ßas simuladas s√£o maiores que o valor observado (positivo) OU menores que o o sim√©trico negativo do nosso valor observado
    -   O valor-p seria: `r p_bilateral` (`r p_bilateral_percent`)
