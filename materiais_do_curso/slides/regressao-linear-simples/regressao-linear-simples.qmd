---
title: "Regressão linear simples"
format: 
  revealjs:
      logo: img/brasao1_horizontal_cor_300dpi.png
      code-link: true
      code-tools: true
      code-line-numbers: false
      theme: simple
      echo: false
      message: false
      warning: false
      css: logo.css
progress: true
slide-number: true
editor: visual
editor_options: 
  chunk_output_type: console
---

```{r}
#| include: false
source("C:/projetos-r/pesquisa-quanti-psi-ufc/_common.R")
```

```{r}
#| label: setup

library(tidyverse)
library(janitor)
library(palmerpenguins)
library(gt)
library(patchwork)
library(broom)
conflicted::conflicts_prefer(dplyr::filter())
conflicted::conflicts_prefer(dplyr::select())
conflicted::conflicts_prefer(dplyr::lag())
conflicted::conflicts_prefer(dplyr::summarize)
conflicted::conflicts_prefer(dplyr::summarise)
conflicted::conflicts_prefer(scales::alpha)
conflicted::conflicts_prefer(scales::rescale)
```

## O que vamos aprender?

# Bancos de dados utilizados

##  {background-image="img/pinguins.png" background-size="contain"}

## `penguins` {.smaller}

Medidas de tamanho para pinguins forrageadores adultos perto da Estação Palmer, Antártida. Inclui medidas para espécies de pinguins, ilha no Arquipélago Palmer, tamanho (comprimento da nadadeira, massa corporal, dimensões do bico) e sexo.

-   Formato: Um banco de dados com `r nrow(penguins)` observações e `r ncol(penguins)` variáveis
    -   `species`: espécies de pinguins (Adélie, Chinstrap e Gentoo)
    -   `island`: ilha no arquipélago de Palmer, Antártida (Biscoe, Dream ou Torgersen)
    -   `bill_length_mm`: comprimento do bico em milímetros
    -   `flipper_length_mm`: comprimento da nadadeira em milímetros
    -   `body_mass_g`: massa corporal em gramas
    -   `sex`: sexo do pinguin (macho ou fêmea)
    -   `year`: ano em que foi realizado o estudo

## Uma olhada em `penguins`

```{r}
#| label: tbl-penguins
#| tbl-cap: Uma amostra aleatória de dez casos do banco de dados `penguins`
#| tbl-cap-location: bottom
penguins |> 
  slice_sample(n = 10) |> 
  gt() |> 
  cols_align(
    align = "center"  
  ) |> 
  tab_options(
    table.width = pct(100),
    table.font.size = "22px"
  ) |> 
  opt_stylize(
    style = 1, color = "gray"
  )
```

## Usos da regressão

-   Examinar o efeito de diferentes variáveis (preditoras / independentes) em uma única variável de resultado (dependente)

-   O uso o termo predição é essencial, pois a análise examina se uma variável prediz (explica ou repercute em) outra variável

## A linha de regressão

```{r}
x <- c(0,1,2,3,4)

y <- 2 + 2*x

reg_line <- tibble(x,y)
```

```{r}
reg_line |> 
  ggplot(
    aes(x,y)
  ) +
  geom_smooth(
    method = "lm", se = F,
    color = "#F05133", linetype = 2
  ) + 
  geom_point(
    color = "#569BBD", alpha = 0.6,
    size = 3
  )
```

## A linha de regressão

$$
y = a + bx
$$

-   y = VI
-   x = VD
-   a = constante (local onde a linha intercepta o eixo y, ou seja, onde x = 0)
-   b = inclinação da linha (cada vez que "x" aumenta 1 unidade, "y" aumenta "b" unidades)

## A linha de regressão

```{r}
reg_line |> 
  gt() |> 
  cols_align(
    align = "center"  
  ) |> 
  tab_options(
    table.width = pct(100),
    table.font.size = "26px"
  ) |> 
  opt_stylize(
    style = 1, color = "gray"
    )
```

Quais os valores de a e b para esta linha de regressão?

. . .

a = 2

. . .

b = 2

## Correlação X Regressão {.smaller}

-   Correlação
    -   Magnitude e direção
-   Regressão
    -   Descobrir o tamanho do efeito de uma variável $x$ (independente, previsora ou explicativa) em uma variável $y$ (dependente, critério ou desfecho)

# Uma variável independente contínua

## 

Quanto a massa corporal dos pinguins (`body_mass_g`) pode variar em função do comprimento da nadadeira (`flipper_length_mm`)?

# Análise de dados exploratória

## Estatísticas e Gráficos {.smaller}

-   Estatística descritiva
    -   Mínimo
    -   Máximo
    -   Média
    -   Desvio padrão
    -   Histogramas
-   Correlações
    -   Bivariadas
    -   Gráficos de dispersão

## Estatísticas univariadas {.smaller}

```{r}
#| label: tbl-univariadas
#| tbl-cap: Estatísticas univariadas para o comprimento da nadadeira e a massa corporal
#| tbl-cap-location: bottom

penguins |> 
  summarise(
    across(c(flipper_length_mm, body_mass_g),list(
      N = \(x)  n(),
      NAs = \(x) sum(is.na(x)),
      Média = \(x) mean(x, na.rm = T),
      "Desvio padrão" = \(x) sd(x, na.rm = T),
      Mínimo = \(x) min(x, na.rm = T),
      Máximo = \(x) max(x, na.rm = T)
    ))
  ) |> 
  pivot_longer(
    cols = everything(),
    names_to = c("Variável", ".value"),
    names_sep = "_(?=[^_]+$)"
  ) |> 
  gt() |> 
  cols_align(
    align = "center"  
  ) |> 
  tab_style_body(
    style = cell_text(align = "left"),
    values = c("flipper_length_mm", "body_mass_g")
  ) |> 
  tab_options(
    table.width = pct(100),
    table.font.size = "26px"
  ) |> 
  opt_stylize(
    style = 1, color = "gray"
  )
```

## Histogramas {.smaller}

```{r}
hist_penguins_flipper <- penguins |> 
  ggplot(
    aes(flipper_length_mm)
  ) +
  geom_histogram(
    fill = "#569BBD",
    color = "#FFFFFF"
  ) 

hist_penguins_body_mass <- penguins |> 
  ggplot(
    aes(body_mass_g)
  ) +
  geom_histogram(
    fill = "#569BBD",
    color = "#FFFFFF"
  )

hist_penguins_flipper + hist_penguins_body_mass
```

## Estatísticas bivariadas {.smaller}

-   2 variáveis numéricas
    -   Gráfico de dispersão
    -   Coeficiente de Correlação

## Gráfico de dispersão

```{r}
#| out-width: 70%

penguins |> 
  ggplot(
    aes(flipper_length_mm, body_mass_g)
  ) +
  geom_jitter(
    color = "#569BBD", alpha = 0.6,
    size = 3
  ) +
  geom_smooth(
    method = "lm", se = F,
    color = "#F05133",linetype = 2
  ) + 
  labs(
    title = "Gráfico de diserpesão da relação\nentre massa corporal e comprimento da nadadeira"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5) 
  )
```

## Coeficiente de correlação {.smaller}

```{r}
#| label: tbl-cor-bmass-flipper
#| tbl-cap: Correlação entre a massa corporal e o comprimento da nadadeira dos pinguins
#| tbl-cap-location: bottom

stats_cor_bmass_flipper <- cor.test(penguins$flipper_length_mm, 
         penguins$body_mass_g)  
  

t_cor_b_mass_flipper <- round(stats_cor_bmass_flipper$statistic[[1]],2)
t_cor_b_mass_flipper <- str_c("t = ", t_cor_b_mass_flipper)  
r_sqrt_b_mass_flipper <- round(stats_cor_bmass_flipper$estimate[[1]]^2,2)
r_sqrt_b_mass_flipper <- str_c("r² = ", r_sqrt_b_mass_flipper)  
t_r_cor_bmass_flipper <- str_c(t_cor_b_mass_flipper, 
                               r_sqrt_b_mass_flipper, sep = "; ")  

tbl_matrix_cor_bmass_flipper <- penguins |> 
  select(flipper_length_mm, 
         body_mass_g) |> 
  drop_na() |> 
  cor() |> 
  as.data.frame() |> 
  rownames_to_column() |> 
  gt() |>
  cols_align(
    align = "center", columns = c(2,3)
  ) |> 
  sub_values(
    columns = 3,
    fn = function(x) x < 1, 
    replacement = "-"
  ) |> 
  fmt_number(
    decimals = 2, drop_trailing_zeros = T 
  ) |> 
  text_transform(
    locations = cells_body(columns = 2, rows = 2),
    fn = function(x) {
      sub("^0\\.", ".", x)  # Remove o "0" antes de ".87"
    }
  ) |> 
  tab_footnote(
    locations = cells_body(columns = 2, rows = 2), 
    footnote = md("*Nota. p* < .001"),
    placement = "right"
  ) |> 
  opt_footnote_marks(
    marks = "extended"
  ) |> 
  tab_source_note(
    source_note = t_r_cor_bmass_flipper
    ) |> 
  tab_options(
    table.width = pct(100),
    table.font.size = "26px"
  )

tbl_matrix_cor_bmass_flipper
```

## O que sabemos até agora sobre a relação entre o comprimento da nadadeira e a massa corporal dos pinguins? {.smaller}

-   A partir do gráfico e do teste de correlação de pearson, o que podemos dizer sobre a nossa equação?
    -   b tem uma inclinação positiva!
    -   Pinguins com com nadadeiras maiores tendem a ter maior massa corporal

## Questões para a regressão {.smaller}

$$
y = a + bx
$$

-   Qual o valor numérico para a incliação (slope) *b*?
-   E o valor do intercepto *a*?
-   Vamos utilizar a regressão linear simples para obter essas respostas

## Tabela de regressão

```{r}
#| label: tbl-reg-bmass-flipper
#| tbl-cap: Tabela de regressão linear simples
#| tbl-cap-location: bottom
modelo_reg_simples_cont <- lm(body_mass_g ~ flipper_length_mm, 
                         data = penguins)

nomes_tabela_regressao_cont <- c("Preditor", "Estimativa",
                            "Erro padrão", "t", "p")

tabela_modelo_reg_simples_cont <- modelo_reg_simples_cont |> 
  tidy() |> 
  mutate(
    across(where(is.double),
           \(x) round(x, 2)),
    ) |> 
  rename_with(~nomes_tabela_regressao_cont) |> 
  gt() |> 
  sub_values(
    columns = 5,
    fn = function(x) x == 0 , 
    replacement = "< .001"
  ) |> 
  cols_align(
    align = "center"  
  ) |> 
  tab_source_note(
    source_note = r_sqrt_b_mass_flipper
    ) |> 
  tab_style_body(
    style = cell_text(align = "left"),
    values = c("flipper_length_mm", "(Intercept)")
  ) |> 
  tab_options(
    table.width = pct(100),
    table.font.size = "22px"
  ) |> 
  opt_stylize(
    style = 1, color = "gray"
  )

tabela_modelo_reg_simples_cont
```

## Interpretando a tabela de regressão {.smaller}

```{r}
a_cont <- modelo_reg_simples_cont$coefficients[[1]]
a_cont <- round(a_cont, 3)
b_cont <- modelo_reg_simples_cont$coefficients[[2]]
b_cont <- round(b_cont, 3)
```

```{r}
tabela_modelo_reg_simples_cont
```

$$
y = a + bx
$$

-   Estimativas
    -   a = Estimativa do Intercepto = `r a_cont`
    -   b = Estimativa de `flipper_length_mm` = `r b_cont`

$$
body\_mass\_g = `r a_cont` + `r b_cont` * flipper\_length\_mm
$$

::: aside
Neste caso, o intercepto da linha de regressão tem uma interpretação matemática, mas ele não tem nenhuma interpretação prática, pois observar um valor de `flipper_length_mm` igual a 0 é impossível
:::

## Interpretando a equação de regressão

$$
body\_mass\_g = `r a_cont` + `r b_cont` * flipper\_length\_mm
$$

::: {style="line-height: 1; font-size: 18pt"}
-   Quais conclusões podemos tirar dessa equação?
    -   O sinal de b é positivo, portanto há uma relação positiva entre as variáveis
        -   Quanto maior a pontuação em `flipper_length_mm` maior a pontuação em `body_mass_g`
        -   Ou seja: um tamanho maior da nadadeira está associado a maior massa corporal dos pinguins
    -   Interpretação do valor de b (estimativa de `flipper_length_mm`):
        -   O coeficiente associado ao comprimento da nadadeira é 49.7. Isso significa que, para cada aumento de 1 mm no comprimento da nadadeira, o peso dos pinguins aumenta em média 49.7 gramas, mantendo todas as outras variáveis constantes.
:::

## Correlação e regressão linear simples

```{r}
tabela_modelo_reg_simples_cont
tbl_matrix_cor_bmass_flipper
```

## Valores observados, valores ajustados e os resíduos {.smaller}

$$
body\_mass\_g = `r a_cont` + `r b_cont`*flipper\_length\_mm
$$

```{r}
penguins |> 
  mutate(
    id = 1:n()
  ) |> 
  select(id, body_mass_g, flipper_length_mm) |> 
  slice_head(n = 1) |> 
  gt() |> 
  cols_align(
    align = "center"  
  ) |> 
  tab_options(
    table.width = pct(100),
    table.font.size = "22px"
  ) |> 
  opt_stylize(
    style = 1, color = "gray"
  )


a <- modelo_reg_simples_cont$coefficients[[1]]
b <- modelo_reg_simples_cont$coefficients[[2]]
x <- penguins[[1, 5]]
ajustado <- a + b*x
observado <- penguins[[1, 6]]
residuo <- observado - ajustado

```

-   Valor observado de body_mass_g = $`r observado`$
-   Valor ajustado/previsto
    -   $body\_mass\_g = `r round(a, 3)` + `r round(b, 3)`* `r x`$
    -   $body\_mass\_g = `r round(ajustado, 3) `$
-   $\text{Resíduo} = \text{valor observado} - \text{valor ajustado}$
    -   $\text{Resíduo} =  `r observado` - `r  round(ajustado, 3)`  = `r round(residuo, 3)`$

## Resíduos

```{r}
modelo_reg_simples_cont |> 
  augment() |> 
  ggplot(
    aes(flipper_length_mm, body_mass_g)
  ) +
  geom_point(
    color = "#569BBD", alpha = 0.6,
    size = 3
  ) +
  geom_point(data = penguins |>  filter(flipper_length_mm == 172), 
             aes(flipper_length_mm, body_mass_g), 
             shape = 1, size = 5, color = "red", stroke = 1.5) +
  geom_smooth(
    method = "lm", se = F,
    color = "#F05133",linetype = 2
  ) + 
  annotate(
    "segment",x = 171.9, xend = 171.9,
    y = 2765, yend = 3100, color = "#F05133",
    linewidth = 1
  ) + 
  
  labs(
    title = "Gráfico de diserpesão da relação\nentre massa corporal e comprimento da nadadeira"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5) 
  )
```

